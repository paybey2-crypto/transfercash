<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
  h1,h2 { margin: 0 0 10px 0; }
  .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: #007BFF; color: #fff; }
  .header #welcome { font-size: 1.2em; font-weight: bold; }
  .header button { background: #fff; color: #007BFF; border: none; padding: 7px 15px; border-radius: 5px; cursor: pointer; font-weight:bold; }
  .header button:hover { background: #e2e6ea; }
  .container { padding: 20px 30px; }
  .section { background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
  .flex { display: flex; gap: 20px; flex-wrap: wrap; }
  .flex > .section { flex:1; min-width: 250px; }
  form input { margin: 5px 5px 5px 0; padding:7px; border-radius:4px; border:1px solid #ccc; }
  form button, button { padding:7px 12px; border:none; border-radius:4px; cursor:pointer; background: #007BFF; color:#fff; font-weight:bold; }
  form button:hover, button:hover { background: #0056b3; }
  ul { list-style:none; padding-left:0; }
</style>
</head>
<body>
<div class="header">
  <div id="welcome">Loading...</div>
  <form id="logoutForm" method="POST" action="/logout">
    <button type="submit">Logout</button>
  </form>
</div>

<div class="container">
  <div class="section">
    <h2>Your balance:</h2>
    <div id="balance">Loading...</div>
  </div>

  <div class="flex">
    <div class="section">
      <h2>Send money to user</h2>
      <form id="transferForm">
        <input type="text" name="toUsername" placeholder="Username" required>
        <input type="number" name="amount" placeholder="Amount" required>
        <button type="submit">Send</button>
      </form>
    </div>

    <div class="section">
      <h2>Send to IBAN</h2>
      <form id="ibanForm">
        <input type="text" name="iban" placeholder="IBAN" required>
        <input type="number" name="amount" placeholder="Amount" required>
        <button type="submit">Send</button>
      </form>
    </div>
  </div>

  <div class="section">
    <h2>Your Virtual Cards</h2>
    <ul id="cardList"></ul>
    <button id="createCardBtn">Create new card</button>
  </div>

  <div class="section" id="adminSection" style="display:none;">
    <h2>All Users (Admin)</h2>
    <ul id="userList"></ul>
  </div>
</div>

<script>
async function loadDashboard() {
  const r = await fetch('/api/me', { credentials: 'same-origin' });
  const user = await r.json();
  document.getElementById('welcome').innerHTML = <strong>Welcome, ${user.username}</strong>;

  // Balance
  const usersRes = await fetch('/api/users', { credentials: 'same-origin' });
  if(usersRes.status===200){
    document.getElementById('adminSection').style.display='block';
    const usersList = await usersRes.json();
    const ul = document.getElementById('userList');
    ul.innerHTML='';
    usersList.forEach(u => { const li=document.createElement('li'); li.textContent=${u.username}: $${u.balance}; ul.appendChild(li); });
    const me = usersList.find(u=>u.username===user.username);
    document.getElementById('balance').textContent = me.balance;
  } else {
    document.getElementById('balance').textContent = user.balance || '0';
  }

  // Load cards
  const cardsRes = await fetch('/api/cards', { credentials: 'same-origin' });
  const cards = await cardsRes.json();
  const ulCards = document.getElementById('cardList');
  ulCards.innerHTML='';
  cards.forEach(c => { const li=document.createElement('li'); li.textContent=${c.cardNumber} | Balance: $${c.balance}; ulCards.appendChild(li); });
}

document.getElementById('transferForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const toUsername = e.target.toUsername.value;
  const amount = parseFloat(e.target.amount.value);
  const res = await fetch('/api/transfer', {
    method:'POST',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({toUsername,amount})
  });
  const data = await res.json();
  if(data.success){ alert('Transfer successful!'); loadDashboard(); } else { alert('Error: '+data.error); }
});

document.getElementById('ibanForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const iban = e.target.iban.value;
  const amount = parseFloat(e.target.amount.value);
  const res = await fetch('/api/iban', {
    method:'POST',
    credentials:'same-origin',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({iban,amount})
  });
  const data = await res.json();
  if(data.success){ alert('IBAN transfer successful!'); loadDashboard(); } else { alert('Error: '+data.error); }
});

document.getElementById('createCardBtn').addEventListener('click', async ()=>{
  const res = await fetch('/api/cards',{method:'POST',credentials:'same-origin'});
  const data = await res.json();
  if(data.success){ alert('Card created: '+data.card.cardNumber); loadDashboard(); }
  else alert('Error: '+data.error);
});

loadDashboard();
</script>
</body>
</html>
