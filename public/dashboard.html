<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<style>
body { font-family: Arial; background:#f0f2f5; margin:0; color:#333; }
.header { display:flex; justify-content:space-between; align-items:center; padding:15px 30px; background:#007BFF; color:#fff; }
.header button { padding:7px 12px; border:none; border-radius:4px; cursor:pointer; background:#fff; color:#007BFF; font-weight:bold; }
.container { padding:20px 30px; }
.section { background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; box-shadow:0 3px 6px rgba(0,0,0,0.1); }
form { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
form input, form select { padding:7px; border-radius:4px; border:1px solid #ccc; flex:1; min-width:100px; }
form input[type=number]{ width:100px; flex:none; }
form select { width:150px; flex:none; }
form button { padding:7px 12px; border:none; border-radius:4px; cursor:pointer; background:#007BFF; color:#fff; font-weight:bold; }
ul { list-style:none; padding-left:0; }
</style>
</head>
<body>
<div class="header">
  <div id="welcome">Loading...</div>
  <form method="POST" action="/logout"><button>Logout</button></form>
</div>

<div class="container">
  <div class="section">
    <h2>Your balance:</h2>
    <div id="balance">Loading...</div>
  </div>

  <div class="section">
    <h2>Send Money</h2>
    <form id="sendForm">
      <input type="text" name="username" placeholder="Username">
      <input type="text" name="iban" placeholder="IBAN">
      <input type="number" name="amount" placeholder="Amount">
      <select name="method">
        <option value="">Payment Method</option>
        <option value="card">Card</option>
        <option value="bank">Bank Transfer</option>
      </select>
      <button type="submit">Send</button>
    </form>
  </div>

  <div class="section">
    <h2>Your Virtual Cards</h2>
    <ul id="cardList"></ul>
    <button id="createCardBtn">Create new card</button>
  </div>

  <div class="section" id="adminSection" style="display:none;">
    <h2>All Users (Admin)</h2>
    <ul id="userList"></ul>
  </div>
</div>

<script>
async function loadDashboard(){
  const r = await fetch('/api/me',{credentials:'same-origin'});
  const user = await r.json();
  document.getElementById('welcome').textContent = `Welcome, ${user.username}`;
  document.getElementById('balance').textContent = user.balance;

  if(user.isAdmin){
    const usersRes = await fetch('/api/users',{credentials:'same-origin'});
    if(usersRes.ok){
      const usersList = await usersRes.json();
      document.getElementById('adminSection').style.display='block';
      const ul = document.getElementById('userList'); ul.innerHTML='';
      usersList.forEach(u=>{ const li=document.createElement('li'); li.textContent=`${u.username}: $${u.balance}`; ul.appendChild(li);});
    }
  }

  // Load cards
  const cardsRes = await fetch('/api/cards',{credentials:'same-origin'});
  const cards = await cardsRes.json();
  const ulCards = document.getElementById('cardList'); ulCards.innerHTML='';
  cards.forEach(c=>{ const li=document.createElement('li'); li.textContent=`${c.cardNumber} | Balance: $${c.balance}`; ulCards.appendChild(li); });
}

document.getElementById('sendForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const form = e.target;
  const res = await fetch('/api/transfer',{method:'POST',credentials:'same-origin',headers:{'Content-Type':'application/json'},body:JSON.stringify({
    toUsername: form.username.value,
    amount: parseFloat(form.amount.value)
  })});
  const data = await res.json();
  if(data.success) alert('Transfer successful'); else alert('Error: '+data.error);
  loadDashboard();
});

document.getElementById('createCardBtn').addEventListener('click', async ()=>{
  const res = await fetch('/api/cards',{method:'POST',credentials:'same-origin'});
  const data = await res.json();
  if(data.success) alert('Card created: '+data.card.cardNumber); else alert('Error: '+data.error);
  loadDashboard();
});

loadDashboard();
</script>
</body>
</html>
